"0",""
"0","# define function for running simulation"
"0","run_simulation <- function(data, condition, n_trials, difficulty_mu, difficulty_sd, prob_error) {"
"0","  "
"0","  # setup simulation parameters"
"0","  difficulty <- rnorm(n_trials, mean = difficulty_mu, sd=difficulty_sd)"
"0","  "
"0","  # create new dataframe for storing results"
"0","  sim_results <- data[, c(1, 2, 5, 7, 9, 10)]  # TODO: Change this to column names for readability"
"0","  sim_results$agent_correct_sum  <- 1  # sum of correct answers for individual, used for calculating reputation"
"0","  sim_results$group_correct_sum  <- 0  # sum of correct answers for group"
"0","  "
"0","  # create vectors for calculating proportion of correct responses"
"0","  diff_vec <- c()"
"0","  mean_vec <- c()"
"0","  "
"0","  # running the trials"
"0","  for (trial in 1:n_trials) {"
"0","    "
"0","    # setup colnames depending on trial"
"0","    col_difficulty       <- paste('difficulty_t',       trial, sep = '')"
"0","    col_prob_correct     <- paste('prob_correct_t',     trial, sep = '')"
"0","    col_agent_answer     <- paste('agent_answer_t',     trial, sep = '')"
"0","    col_agent_reputation <- paste('agent_reputation_t', trial, sep = '')"
"0","    col_ <- paste('agent_reputation_t', trial, sep = '')"
"0","    col_group_answer     <- paste('group_answer_t',     trial, sep = '')"
"0","    "
"0","    "
"0","    # save difficulty"
"0","    sim_results[[col_difficulty]] <- difficulty[trial]"
"0","    "
"0","    # calculate each agents reputation"
"0","    sim_results[[col_agent_reputation]] <- sim_results$agent_correct_sum / trial"
"0","    "
"0","    "
"0","    # Calculate weight for group based on confidence and reputation"
"0","    sim_results <- sim_results %>%"
"0","      group_by(group_id) %>%"
"0","      mutate(conf_rep_sum = sum(confidence * get(col_agent_reputation)))  # weight of confidence and reputation on group level"
"0","    "
"0","    sim_results$conf_group_prob <- ((sim_results$confidence * sim_results[[col_agent_reputation]]) / sim_results$conf_rep_sum)  # individual agent weight"
"0","    "
"0","    "
"0","    # calculate agent probability of getting a correct response and the actual response"
"0","    sim_results[[col_prob_correct]] <- lapply(sim_results$knowledge_scaled * sim_results[[col_difficulty]],"
"0","                                              FUN = agent_prob_adjust,"
"0","                                              prob_error = prob_error)"
"0","    "
"0","    sim_results[[col_agent_answer]] <- lapply(sim_results[[col_prob_correct]],"
"0","                                              FUN = agent_decision)"
"0","    "
"0","    # convert to proper data types"
"0","    sim_results[[col_prob_correct]] <- as.numeric(sim_results[[col_prob_correct]])"
"0","    sim_results[[col_agent_answer]] <- as.integer(sim_results[[col_agent_answer]])"
"0","    "
"0","    # select group decision"
"0","    sim_results <- sim_results %>% "
"0","      group_by(group_id) %>% "
"0","      mutate(!!col_group_answer := baseline_decision(a1_answer = get(col_agent_answer)[1],"
"0","                                                       a2_answer = get(col_agent_answer)[2],"
"0","                                                       a3_answer = get(col_agent_answer)[3],"
"0","                                                       a1_prob   = conf_group_prob[1],"
"0","                                                       a2_prob   = conf_group_prob[2],"
"0","                                                       a3_prob   = conf_group_prob[3] ))"
"0","    "
"0","    # calculate sum of correct responses"
"0","    sim_results$agent_correct_sum <- sim_results$agent_correct_sum + sim_results[[col_agent_answer]]"
"0","    sim_results$group_correct_sum <- sim_results$group_correct_sum + sim_results[[col_group_answer]]"
"0","    "
"0","    # saving of mean scores to print"
"0","    diff_vec <- append(diff_vec, difficulty[trial])"
"0","    mean_vec <- append(mean_vec, mean(sim_results[[col_group_answer]]))"
"0","    "
"0","  }"
"0","  "
"0","  # print the stats"
"0","  message(paste('AVG Difficulty: ', mean(diff_vec)))"
"0","  message(paste('AVG Correct:    ', mean(mean_vec)))"
"0","  "
"0","  return(sim_results)"
"0","}"
"0",""
"0",""
