---
title: "Confidence in Joint Decision Making - A Simulation-Based Approach"
author: "Mie Arnau Martinez & Tobias Frisenborg Christensen"
date: "4/15/2020"
output: word_document
---

#  ABM Specifications and Parameters
## Properties of Agents
  - *Knowledge:* Normal distribution with mu=100 and sd=15 (like IQ)
    **https://www.mensa.org/iq/what-iq**
  - *Confidence Level:* Factor for confidence calculation, that reflects the mismatch between believed knowledge and true knowledge.
  - *Confidence:* (knowledge * confidence)
  - *Reputation:* Proportion of correct responses out of total responses

## Properties of Groups
  - *Decision:*
    - Baseline: Confidence is the only factor for the group decision function (equality bias)
      Weight of agent response is calculated as **confidence / sum(confidence)**
    - Reputation: All agents can assign weights to their group members answers, based on reputation, to mitigate the equality bias.
      Weight of agent response is calculated as ...
        
    - Confirmation: If other agents have the same response, the weight of that response is increased (confirmation bias).
      Weight of agent response is calculated as ...
        

## Updating of properties:
  - *Reputation:* Proportion of correct responses in decimal percent
    (Updated at the end of each round)

Experimental setup:
  - *Manipulated Variables*
    - Group decision function (baseline/equality, reputation, confirmation)
    - Confidence
    - Group composition in relation to proportion of over- and unconfident agents
  - *Environment:*
    - Influence of reputation and confirmation bias in multiple models, versus one baseline model (equality bias)
  - *Outcome:*
    - Performance of group (mean payoff over trials)
    - Performance of group (time to find correct solution)



```{r Setup, include=FALSE}

# TODO: FIgure out how much confirmation and reputation weighs in decision function

setwd("~/Code/SocKult_exam")

# load libraries
library(pacman)
pacman::p_load(tidyverse, tictoc, ggridges)

# setup randomization paramter for replication
seed = 123
set.seed(seed)

# read functions
source('functions/min_max_scale.R')
source('functions/create_agents.R')
source('functions/agent_prob_adjust.R')
source('functions/agent_decision.R')
source('functions/group_decision.R')
source('functions/run_simulation.R')
source('functions/plot_results.R')

```



``` {r Setup Paramters}

### SETUP PARAMETERS ###
# agents
n_groups              <- 100
group_size            <- 3
conf_influence_factor <- 1

# simulation
n_trials              <- 40
group_strategy        <- 'highest_weight'  # c('sample_weighted', 'highest_weight')
difficulty_mu         <- 1.0
difficulty_sd         <- 0.25
prob_error            <- 0.01
confirmation_weight   <- 2.33

```



``` {r Create Agents}

### CREATING AGENTS ###
agent_attr       <- create_agents(n_groups              = n_groups,
                                  group_size            = group_size,
                                  conf_influence_factor = conf_influence_factor,
                                  seed                  = seed)

```



``` {r Simulation}

### RUNNING THE SIMULATION ###
# baseline condition
sim_baseline     <- run_simulation(data                 = agent_attr,
                                   condition            = 'baseline',
                                   group_strategy       = group_strategy,
                                   n_trials             = n_trials,
                                   difficulty_mu        = difficulty_mu,
                                   difficulty_sd        = difficulty_sd,
                                   prob_error           = prob_error,
                                   seed                 = seed)

# baseline condition
sim_equality     <- run_simulation(data                 = agent_attr,
                                   condition            = 'equality',
                                   group_strategy       = group_strategy,
                                   n_trials             = n_trials,
                                   difficulty_mu        = difficulty_mu,
                                   difficulty_sd        = difficulty_sd,
                                   prob_error           = prob_error,
                                   seed                 = seed)

# reputation condition
sim_reputation   <- run_simulation(data                 = agent_attr,
                                   condition            = 'reputation',
                                   group_strategy       = group_strategy,
                                   n_trials             = n_trials,
                                   difficulty_mu        = difficulty_mu,
                                   difficulty_sd        = difficulty_sd,
                                   prob_error           = prob_error,
                                   seed                 = seed)

# confirmation condition
sim_confirmation <- run_simulation(data                 = agent_attr,
                                   condition            = 'confirmation',
                                   group_strategy       = group_strategy,
                                   confirmation_weight  = confirmation_weight,
                                   n_trials             = n_trials,
                                   difficulty_mu        = difficulty_mu,
                                   difficulty_sd        = difficulty_sd,
                                   prob_error           = prob_error,
                                   seed                 = seed)



### PRINT SOME QUICK PLOTS ###
plot_results(sim_baseline, sim_equality, sim_reputation, sim_confirmation)

```








``` {r Analysis}

# bind data together
data <- rbind(sim_baseline, sim_equality, sim_reputation, sim_confirmation)

### CALCULATIONS ###
# calculate overall group performance
data <- data %>% 
  group_by(agent_id, condition) %>% 
  mutate(group_performance = sum(group_answer))

# calculate cumulative group performance
data <- data %>% 
  group_by(agent_id, condition) %>% 
  mutate(cum_performance = cumsum(group_answer))

# calculate knowledge spread
data <- data %>%
  group_by(group_id) %>% 
  mutate(knowledge_sd = sd(knowledge), knowledge_iqr = IQR(knowledge))


# calculate performance averaged by trial
data_summary <- data[data$trial_n == max(data$trial_n), ]

# make conditions pretty
data$condition <- tools::toTitleCase(data$condition)
data$condition <- as.factor(data$condition)
data$condition <- ordered(data$condition, levels = c("Baseline",
                                                     "Equality",
                                                     "Reputation",
                                                     "Confirmation"))




data$confidence_mismatch <- data$prob_correct - data$confidence

mean(data$confidence_mismatch)
sd(data$confidence_mismatch)


ggplot(data, aes(x = prob_correct, y = condition, fill = condition)) +
  geom_density_ridges(rel_min_height = 0.005, scale = 1.5, alpha=.95) +
  scale_fill_cyclical(values = c("#eb5146", "#3b44ed", "#981dd1", "#23de8d")) +
  theme_ridges() +
  theme(text = element_text(size = 10), legend.position = "none") +
  labs(title = "Group Performance Ridgeline Plot",
       x = "Mean Group Performance",
       y = "")


ggplot(data, aes(x = confidence, y = condition, fill = condition)) +
  geom_density_ridges(rel_min_height = 0.005, scale = 1.5, alpha=.95) +
  scale_fill_cyclical(values = c("#eb5146", "#3b44ed", "#981dd1", "#23de8d")) +
  theme_ridges() +
  theme(text = element_text(size = 10), legend.position = "none") +
  labs(title = "Group Performance Ridgeline Plot",
       x = "Mean Group Performance",
       y = "")

```




